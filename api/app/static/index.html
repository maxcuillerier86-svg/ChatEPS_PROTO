<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Co-PE Local UI</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f7fb;margin:0;color:#16202a}
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    input,textarea,button,select{padding:8px;border:1px solid #ccd3dd;border-radius:8px}
    button{background:#2458d3;color:#fff;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:12px}
    .msg{padding:8px;border-bottom:1px solid #eef2f6}
    .assistant{background:#f3f7ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:#667085;font-size:13px}
    .pdf-list{max-height:170px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 style="margin:0">Co-PE ‚Äì Interface locale</h1>
    <p>Utilisez un pseudo, stockez des PDF localement et discutez avec l‚ÄôIA + vos sources.</p>
  </div>

  <div class="card">
    <h3>Session</h3>
    <div class="row">
      <input id="pseudo" placeholder="Votre pseudo" value="Max" />
      <select id="model"></select>
      <input id="other-model" placeholder="OTHER: ex. gpt-oss:20b" style="min-width:220px" />
      <button onclick="setOtherModel()">Utiliser OTHER</button>
      <button onclick="pullCurrentModel()">Pull mod√®le</button>
      <button onclick="startSession()">D√©marrer</button>
      <span id="session-status"></span>
    </div>
    <p class="muted">Presets: gpt-oss:20b, llama3.1, llama3.2, mistral, qwen2.5. En local Windows: `OLLAMA_URL=http://localhost:11434`.</p>
  </div>

  <div class="card">
    <h3>Biblioth√®que PDF locale (RAG)</h3>
    <div class="row">
      <input id="pdf-title" placeholder="Titre du PDF" style="min-width:220px" />
      <input id="pdf-file" type="file" accept="application/pdf" />
      <button onclick="uploadPdf()">Uploader PDF</button>
      <button onclick="refreshPdfs()">Rafra√Æchir</button>
      <label><input id="use-rag" type="checkbox" checked /> Utiliser RAG</label>
      <span id="pdf-status"></span>
    </div>
    <div id="pdfs" class="pdf-list"></div>
    <p class="muted">S√©lectionnez un ou plusieurs PDF: seules ces sources seront utilis√©es dans la r√©ponse IA.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Conversations</h3>
      <button onclick="createConversation()">Nouveau fil</button>
      <div id="conversations"></div>
    </div>

    <div class="card">
      <h3>Chat</h3>
      <div id="messages" style="min-height:280px;max-height:420px;overflow:auto"></div>
      <textarea id="prompt" rows="4" style="width:100%">Aide-moi √† cr√©er un plan de s√©ance volleyball √† partir des PDF s√©lectionn√©s.</textarea>
      <div style="margin-top:8px">
        <button onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </div>
</div>

<script>
let pseudo = localStorage.getItem('pseudo') || '';
let selectedModel = localStorage.getItem('model') || '';
let currentConversationId = null;
let selectedPdfIds = [];
const PRESET_MODELS = ['gpt-oss:20b', 'llama3.1', 'llama3.2', 'mistral', 'qwen2.5'];

async function readErrorMessage(res){
  try{
    const data = await res.json();
    return data.detail || JSON.stringify(data);
  }catch{
    return await res.text();
  }
}

function getHeaders(extra = {}) {
  if (!pseudo) throw new Error('Pseudo requis');
  return { 'X-Pseudo': pseudo, ...extra };
}

async function api(path, opts={}){
  const headers = opts.headers || {};
  if (!(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
  Object.assign(headers, getHeaders());
  const res = await fetch(path, {...opts, headers});
  if (!res.ok) throw new Error(await readErrorMessage(res));
  return res;
}

function fillModelSelect(models){
  const select = document.getElementById('model');
  select.innerHTML = '';
  const merged = [...new Set([...PRESET_MODELS, ...(models||[])])];
  merged.forEach((m) => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    select.appendChild(opt);
  });
  if (selectedModel && merged.includes(selectedModel)) {
    select.value = selectedModel;
  } else if (merged.length) {
    select.value = merged[0];
  }
}

async function loadModels() {
  try {
    const res = await fetch('/chat/models');
    const data = await res.json();
    fillModelSelect(data.models || []);
  } catch {
    fillModelSelect([]);
  }
}

function setOtherModel(){
  const other = document.getElementById('other-model').value.trim();
  if(!other) return;
  const select = document.getElementById('model');
  if(!Array.from(select.options).find(o => o.value === other)){
    const opt = document.createElement('option');
    opt.value = other;
    opt.textContent = other + ' (OTHER)';
    select.appendChild(opt);
  }
  select.value = other;
  selectedModel = other;
  localStorage.setItem('model', selectedModel);
  document.getElementById('session-status').innerText = `üß† Mod√®le s√©lectionn√©: ${selectedModel}`;
}

async function pullCurrentModel(){
  try{
    const model = document.getElementById('model').value || document.getElementById('other-model').value.trim();
    if(!model) throw new Error('S√©lectionnez ou saisissez un mod√®le');
    document.getElementById('session-status').innerText = `‚è≥ Pull en cours: ${model}`;
    const res = await fetch('/chat/models/pull', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model})
    });
    if(!res.ok) throw new Error(await readErrorMessage(res));
    await loadModels();
    document.getElementById('model').value = model;
    selectedModel = model;
    localStorage.setItem('model', selectedModel);
    document.getElementById('session-status').innerText = `‚úÖ Mod√®le pr√™t: ${model}`;
  }catch(e){
    document.getElementById('session-status').innerText = `‚ùå ${e.message}`;
  }
}

async function startSession(){
  try{
    pseudo = document.getElementById('pseudo').value.trim();
    selectedModel = document.getElementById('model').value;
    if(!pseudo) throw new Error('Pseudo obligatoire');
    localStorage.setItem('pseudo', pseudo);
    localStorage.setItem('model', selectedModel);
    document.getElementById('session-status').innerText = `‚úÖ Session: ${pseudo} | mod√®le: ${selectedModel}`;
    await Promise.all([loadConversations(), refreshPdfs()]);
  }catch(e){
    document.getElementById('session-status').innerText = '‚ùå ' + e.message;
  }
}

async function uploadPdf(){
  try{
    const title = document.getElementById('pdf-title').value.trim();
    const fileInput = document.getElementById('pdf-file');
    const file = fileInput.files && fileInput.files[0];
    if(!title) throw new Error('Titre PDF requis');
    if(!file) throw new Error('Choisir un fichier PDF');
    const form = new FormData();
    form.set('title', title);
    form.set('file', file);
    document.getElementById('pdf-status').innerText = '‚è≥ Upload/ingestion...';
    const res = await fetch('/library/upload', { method:'POST', headers:getHeaders(), body:form });
    if(!res.ok) throw new Error(await readErrorMessage(res));
    document.getElementById('pdf-status').innerText = '‚úÖ PDF envoy√©';
    fileInput.value = '';
    await refreshPdfs();
  }catch(e){
    document.getElementById('pdf-status').innerText = `‚ùå ${e.message}`;
  }
}

function renderPdfs(items){
  const box = document.getElementById('pdfs');
  box.innerHTML = '';
  if(!items.length){
    box.innerHTML = '<span class="muted">Aucun PDF pour le moment.</span>';
    return;
  }
  items.forEach(d=>{
    const row = document.createElement('div');
    row.style.marginBottom = '6px';
    const checked = selectedPdfIds.includes(d.id) ? 'checked' : '';
    row.innerHTML = `<label><input type="checkbox" data-id="${d.id}" ${checked}/> <b>${d.title}</b> ‚Äî ${d.status}</label>`;
    box.appendChild(row);
  });
  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const id = Number(cb.getAttribute('data-id'));
      if(cb.checked){
        if(!selectedPdfIds.includes(id)) selectedPdfIds.push(id);
      }else{
        selectedPdfIds = selectedPdfIds.filter(x=>x!==id);
      }
    });
  });
}

async function refreshPdfs(){
  try{
    const res = await api('/library/documents');
    const docs = await res.json();
    selectedPdfIds = selectedPdfIds.filter(id => docs.some(d => d.id === id));
    renderPdfs(docs);
  }catch(e){
    document.getElementById('pdf-status').innerText = `‚ùå ${e.message}`;
  }
}

async function createConversation(){
  const res = await api('/chat/conversations',{method:'POST', body:JSON.stringify({title:`Fil de ${pseudo}`, mode:'co_design'})});
  const conv = await res.json();
  if (!conv || typeof conv.id !== 'number') throw new Error('Conversation invalide retourn√©e par l‚ÄôAPI');
  currentConversationId = conv.id;
  await loadConversations();
  await loadMessages(conv.id);
}

async function loadConversations(){
  const res = await api('/chat/conversations');
  const items = await res.json();
  const el = document.getElementById('conversations');
  el.innerHTML = '';
  items.forEach(c=>{
    const b = document.createElement('button');
    b.textContent = `${c.title} (${c.mode})`;
    b.style.display='block'; b.style.margin='8px 0';
    b.onclick = ()=> loadMessages(c.id);
    el.appendChild(b);
  });
}

async function loadMessages(id){
  if (id === undefined || id === null || Number.isNaN(Number(id))) return;
  currentConversationId = Number(id);
  const res = await api(`/chat/conversations/${id}/messages`);
  const msgs = await res.json();
  const box = document.getElementById('messages');
  box.innerHTML='';
  msgs.forEach(m=>appendMessage(m.role, m.content));
}

function appendMessage(role, content){
  const box = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'assistant' ? 'assistant' : '');
  div.innerHTML = `<b>${role}:</b> ${String(content).replace(/\n/g,'<br/>')}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

async function sendMessage(){
  if(!currentConversationId) return alert('Cr√©ez ou s√©lectionnez une conversation');
  const content = document.getElementById('prompt').value;
  const useRag = document.getElementById('use-rag').checked;
  selectedModel = document.getElementById('model').value;
  localStorage.setItem('model', selectedModel);

  appendMessage('user', content);
  const aiNode = appendMessage('assistant', '');

  const res = await fetch(`/chat/conversations/${currentConversationId}/stream`, {
    method:'POST',
    headers:getHeaders({'Content-Type':'application/json'}),
    body: JSON.stringify({content, use_rag:useRag, collection_ids:selectedPdfIds, model:selectedModel})
  });
  if(!res.ok){
    aiNode.innerHTML = `<b>assistant:</b> ‚ùå ${await readErrorMessage(res)}`;
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let built = '';
  while(true){
    const {done, value} = await reader.read();
    if(done) break;
    const chunk = decoder.decode(value);
    chunk.split('\n\n').forEach(line=>{
      if(!line.startsWith('data:')) return;
      const data = JSON.parse(line.slice(5).trim());
      if(data.token){
        built += data.token;
        aiNode.innerHTML = `<b>assistant:</b> ${built.replace(/\n/g,'<br/>')}`;
      }
    });
  }
}

(async function init(){
  document.getElementById('pseudo').value = pseudo || 'Max';
  await loadModels();
  if (selectedModel && Array.from(document.getElementById('model').options).find(o => o.value === selectedModel)) {
    document.getElementById('model').value = selectedModel;
  }
  if (pseudo) {
    document.getElementById('session-status').innerText = `‚úÖ Session: ${pseudo}`;
    try { await Promise.all([loadConversations(), refreshPdfs()]); } catch {}
  }
})();
</script>
</body>
</html>
